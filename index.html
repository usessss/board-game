<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë©”ì¸í˜ì´ì§€</title>

  <link rel="stylesheet" href="./styles/index.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:ital,wght@0,100..900;1,100..900&family=Oswald:wght@200..700&family=Smooch+Sans:wght@100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Stack+Sans+Notch:wght@200..700&display=swap" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
</head>

<body>
    <!-- í—¤ë” -->
    <header>
      <div>
        <!-- <a href="/board-game/index.html"> -->
          <a href="./index.html">
          <img src="./images/Screenshot_20251118_085515_KakaoTalk-Photoroom.png" alt="ë´‰ìš°ë¦¬ ë¡œê³ ">
        </a>
      </div>
    </header>

    <!-- ë©”ë‰´ í† ê¸€ ë²„íŠ¼ -->
    <button class="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°">ğŸ”</button>

    <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
    <nav class="side-menu" aria-hidden="true">
      <div class="side-menu__header">
        <button class="side-menu__close" aria-label="ë©”ë‰´ ë‹«ê¸°">âŒ</button>
      </div>
      
      <div class="side-menu__body">
        <ul>
          <li>
            <!-- <a href="/board-game/place.html"> -->
              <a href="./place.html">
              ğŸ‘€ ì›”ë³„ë¡œ ì¶œì„ì²´í¬ í•œëˆˆì— ë³´ê¸°
            </a>
          </li>
          <li>
            <!-- <a href="/board-game/money.html"> -->
              <a href="./money.html">
              ğŸ’¸ ì¼ì°¸ë¹„/ì›”ì •ì•¡ ì…ê¸ˆí•˜ê¸°
            </a>
          </li>
          <li><a href="#">ğŸ¯ ë´‰ìš°ë¦¬ ì•„ì§€íŠ¸ ìœ„ì¹˜ë³´ê¸°</a></li>
          <li><a href="#">ğŸš˜ ì£¼ì°¨ ê°€ëŠ¥í•œ ê³³ ë³´ê¸°</a></li>
        </ul>

        <button id="attendance-btn" class="btn">
          ì¶œì„ ì²´í¬
        </button>
      </div>
    </nav>
    <div class="side-overlay" tabindex="-1"></div>

    <div id='calendar'></div>

    <script>
      // ì‚¬ì´ë“œë©”ë‰´ í† ê¸€
      (function(){
        var $menuToggle = $('.menu-toggle');
        var $side = $('.side-menu');
        var $overlay = $('.side-overlay');

        function openMenu(){
          $side.addClass('open').attr('aria-hidden','false');
          $overlay.addClass('show');
        }
        function closeMenu(){
          $side.removeClass('open').attr('aria-hidden','true');
          $overlay.removeClass('show');
        }

        $menuToggle.on('click', openMenu);
        $('.side-menu__close, .side-overlay').on('click', closeMenu);
      })();

      // ê²€ìƒ‰ì°½
      var $searchToggle = $('.search-toggle');

      $searchToggle.on('click', function (e) {
        var $target = $(this);
        var $container = $target.closest('.search-wrapper');
        
        if (!$container.hasClass('active')) {
          $container.addClass('active');
          e.preventDefault();
        } else if ($container.hasClass('active') && $target.closest('.input-holder').length == 0) {
          $container.removeClass('active');
          $container.find('.search-input').val('');
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        // ==========================
        // 1. ì €ì¥ëœ ì¶œì„ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
        // ==========================
        function loadSavedAttendance() {
          const saved = JSON.parse(localStorage.getItem("attendance") || "{}");

          Object.keys(saved).forEach(date => {
            let names = saved[date];
            // ì´ì „ ë²„ì „ í˜¸í™˜: ë‹¨ì¼ ë¬¸ìì—´ì´ë©´ ë°°ì—´ë¡œ ë³€í™˜
            if (!Array.isArray(names)) names = names ? [names] : [];
            names.forEach(name => {
              calendar.addEvent({
                title: name,
                start: date,
                allDay: true
              });
            });
          });
        }

        // ==========================
        // 2. ì¶œì„ ì €ì¥ í•¨ìˆ˜
        // ==========================
        function saveAttendance(name, date) {
          const saved = JSON.parse(localStorage.getItem("attendance") || "{}");
          saved[date] = saved[date] || [];
          // ì´ì „ì— ë‹¨ì¼ ë¬¸ìì—´ë¡œ ì €ì¥ëœ ê²½ìš° ì²˜ë¦¬
          if (!Array.isArray(saved[date])) saved[date] = saved[date] ? [saved[date]] : [];
          // ë™ëª…ì´ì¸ í—ˆìš©: ì¤‘ë³µ ê²€ì‚¬ ì—†ì´ ë¬´ì¡°ê±´ ì¶”ê°€
          saved[date].push(name);
          localStorage.setItem("attendance", JSON.stringify(saved));
        }

        // ì´ë¦„ ìˆ˜ì •
        function updateAttendance(date, oldName, newName) {
          const saved = JSON.parse(localStorage.getItem("attendance") || "{}");
          if (!saved[date]) return;

          const idx = saved[date].indexOf(oldName);
          if (idx !== -1) saved[date][idx] = newName;

          localStorage.setItem("attendance", JSON.stringify(saved));
        }

        // ì´ë¦„ ì‚­ì œ
        function removeAttendance(date, name) {
          const saved = JSON.parse(localStorage.getItem("attendance") || "{}");
          if (!saved[date]) return;

          saved[date] = saved[date].filter(n => n !== name);

          if (saved[date].length === 0) delete saved[date];

          localStorage.setItem("attendance", JSON.stringify(saved));
        }

        // ==========================
        // 3. FullCalendar ì„¤ì •
        // ==========================
        let calendarEl = document.getElementById("calendar");
        let calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          locale: "ko",          // í•œêµ­ì–´
          height: "auto",
          dayHeaderFormat: { weekday: "short" },  // ìš”ì¼: ì›”, í™”, ìˆ˜
          dayCellContent(info) {
            return { html: `<span>${info.date.getDate()}</span>` };
          },
          headerToolbar: {
            left: "prev,next",
            center: "title",
            right: ""            // today ë²„íŠ¼ ì œê±°
          },

          dateClick: function(info) {
            const clickedDate = info.dateStr;   // yyyy-mm-dd

            let name = prompt(clickedDate + " ì¶œì„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            if (!name) return;

            // 1) ìº˜ë¦°ë”ì— í‘œì‹œ
            calendar.addEvent({
              title: name,
              start: clickedDate,
              allDay: true
            });

            // 2) ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
            saveAttendance(name, clickedDate);

            alert("ë“±ë¡ ì™„ë£Œ!");
          },

          dayMaxEvents: 3,
          moreLinkText: function(args) {
            return "â• ë”ë³´ê¸°";   // ìˆ«ì ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥
          },
          moreLinkClick: "popover",

          // ì´ë²¤íŠ¸ í´ë¦­í•´ì„œ ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥
          eventClick: function(info) {
            const oldName = info.event.title;
            const date = info.event.startStr;

            const newName = prompt(
              "ì´ë¦„ ìˆ˜ì • ë˜ëŠ” ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nìˆ˜ì •í•˜ë ¤ë©´ ìƒˆ ì´ë¦„ ì…ë ¥\nì‚­ì œí•˜ë ¤ë©´ ë¹ˆì¹¸ or ì·¨ì†Œ",
              oldName
            );

            // ì‚­ì œ
            if (newName === null || newName.trim() === "") {
              info.event.remove();
              removeAttendance(date, oldName);
              return;
            }

            // ìˆ˜ì •
            info.event.setProp("title", newName);
            updateAttendance(date, oldName, newName);
          }
        });

        calendar.render();

        // ì €ì¥ëœ ì¶œì„ ë¡œë”©
        loadSavedAttendance();

        // ==========================
        // 4. ì¶œì„ ë²„íŠ¼ ì´ë²¤íŠ¸
        // ==========================
        $("#attendance-btn").on("click", function (e) {
          e.stopPropagation(); // ë‹¤ë¥¸ í´ë¦­ ì´ë²¤íŠ¸ ë§‰ê¸°

          let name = prompt("ì¶œì„ì²´í¬í•  ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

          if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤!");

          let today = new Date().toISOString().split("T")[0];

          // ë‹¬ë ¥ í‘œì‹œ
          calendar.addEvent({
            title: name,
            start: today,
            allDay: true,
          });

          // ë¡œì»¬ ì €ì¥
          saveAttendance(name, today);

          // ì„œë²„ ì €ì¥ (ì„ íƒ)
          fetch("http://localhost:3000/attendance", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date: today, name }),
          });

          alert("ì¶œì„ ì™„ë£Œ!");
        });
      });
    </script>
</body>
</html>