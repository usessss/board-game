<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë´‰ìš°ë¦¬ ì¶œì²µ</title>

  <link rel="icon" type="image/png" href="./images/Screenshot_20251118_085515_KakaoTalk-Photoroom.png">

  <link rel="stylesheet" href="./styles/index.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:ital,wght@0,100..900;1,100..900&family=Oswald:wght@200..700&family=Smooch+Sans:wght@100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Stack+Sans+Notch:wght@200..700&display=swap" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

  <!-- Firebase ì´ˆê¸°í™” (module ë°©ì‹) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // â†’ ì—¬ê¸° firebaseConfigë¥¼ "í†µì§¸ë¡œ" ë¶™ì—¬ë„£ì–´
    const firebaseConfig = {
      apiKey: "AIzaSyD1KyOhE1NlQtRIzSHIiab7KIKF2L-mc34",
      authDomain: "board-game-72c4e.firebaseapp.com",
      databaseURL: "https://board-game-72c4e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "board-game-72c4e",
      storageBucket: "board-game-72c4e.firebasestorage.app",
      messagingSenderId: "761901243936",
      appId: "1:761901243936:web:4875105f24a1b35e122645",
      measurementId: "G-DG0J9K8VQV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ì „ì—­ìœ¼ë¡œ ì“°ê¸° í¸í•˜ê²Œ
    window.db = db;
    window.dbRef = ref;
    window.dbPush = push;
    window.dbSet = set;
    window.dbGet = get;
    window.dbUpdate = update;
    window.dbRemove = remove;
  </script>
</head>

<body>
    <!-- í—¤ë” -->
    <header>
      <div>
        <!-- <a href="/board-game/index.html"> -->
          <a href="./index.html">
          <img 
            src="./images/Screenshot_20251118_085515_KakaoTalk-Photoroom.png" 
            alt="ë´‰ìš°ë¦¬ ë¡œê³ "
          >
        </a>
      </div>
    </header>

    <!-- ë©”ë‰´ í† ê¸€ ë²„íŠ¼ -->
    <button class="menu-toggle" aria-label="ë©”ë‰´ ì—´ê¸°">ğŸ”</button>

    <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
    <nav class="side-menu" aria-hidden="true">
      <div class="side-menu__header">
        <button class="side-menu__close" aria-label="ë©”ë‰´ ë‹«ê¸°">âŒ</button>
      </div>
      
      <div class="side-menu__body">
        <ul>
          <li>
            <!-- <a href="/board-game/see.html"> -->
              <a href="./see.html">
              ğŸ‘€ ì›”ë³„ë¡œ ì¶œì„ì²´í¬ í•œëˆˆì— ë³´ê¸°
            </a>
          </li>
          <li>
            <!-- <a href="/board-game/money.html"> -->
              <a href="./money.html">
              ğŸ’¸ ì¼ì°¸ë¹„/ì›”ì •ì•¡ ì…ê¸ˆí•˜ê¸°
            </a>
          </li>
          <li>
            <!-- <a href="/board-game/place.html"> -->
            <a href="./place.html">
              ğŸ¯ ë´‰ìš°ë¦¬ ì•„ì§€íŠ¸ ìœ„ì¹˜ë³´ê¸°
            </a>
          </li>
          <li>
            <!-- <a href="/board-game/parking.html"> -->
            <a href="./parking.html">
              ğŸš˜ ì£¼ì°¨ ê°€ëŠ¥í•œ ê³³ ë³´ê¸°
            </a>
          </li>
          <li>
            <!-- <a href="/board-game/tichu.html"> -->
            <a href="./tichu.html">
              ğŸ‰ í‹°ì¶” í•œíŒ ğŸ¦â€ğŸ”¥
            </a>
          </li>
        </ul>

        <button id="attendance-btn" class="btn" style="font-size: small !important;">
          ì˜¤ëŠ˜ ë‚ ì§œì— ì¶œì„ ì²´í¬í•˜ê¸°
        </button>
      </div>
    </nav>
    <div class="side-overlay" tabindex="-1"></div>

    <div id='calendar'></div>

    <!-- ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ -->
    <div id="colorModal" class="color-modal" style="
      display:none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.5); 
      justify-content: center; 
      align-items: center;
      z-index: 5000;
    ">
      <div style="background:#fff; padding:20px; border-radius:10px; width:250px;">
        <h3 style="margin-top:0;">ìƒ‰ìƒ ì„ íƒ</h3>

        <label>ì»¬ëŸ¬í”¼ì»¤</label>
        <input type="color" id="colorPicker" style="width:100%; height:40px;">

        <label style="margin-top:10px; display:block;">HEX ì½”ë“œ</label>
        <input type="text" id="colorHex" maxlength="7" placeholder="#000000" style="width:100%; padding:5px;">

        <button id="colorOk" style="margin-top:15px; width:100%; padding:8px; background:#2a8; color:#fff; border:none; border-radius:5px;">í™•ì¸</button>
        <button id="colorCancel" style="margin-top:5px; width:100%; padding:8px; background:#ccc; border:none; border-radius:5px;">ì·¨ì†Œ</button>
      </div>
    </div>

    <script>
      // side menu toggle
      (function(){
        var $menuToggle = $('.menu-toggle');
        var $side = $('.side-menu');
        var $overlay = $('.side-overlay');

        function openMenu(){
          $side.addClass('open').attr('aria-hidden','false');
          $overlay.addClass('show');
        }
        function closeMenu(){
          $side.removeClass('open').attr('aria-hidden','true');
          $overlay.removeClass('show');
        }

        $menuToggle.on('click', openMenu);
        $('.side-menu__close, .side-overlay').on('click', closeMenu);
      })();

      // ------------------------------
      // Firebase CRUD í•¨ìˆ˜
      // ------------------------------

      async function saveAttendance(date, name, color) {
        const newRef = window.dbPush(window.dbRef(window.db, "attendance"));
        await window.dbSet(newRef, { date, name, color });
        return { id: newRef.key, date, name, color };
      }

      async function deleteAttendance(id) {
        return window.dbRemove(window.dbRef(window.db, "attendance/" + id));
      }

      async function editAttendance(id, newName) {
        return window.dbUpdate(window.dbRef(window.db, "attendance/" + id), { name: newName });
      }

      async function loadAttendance(calendar) {
        const snapshot = await window.dbGet(window.dbRef(window.db, "attendance"));
        if (snapshot.exists()) {
          const data = snapshot.val();
          Object.keys(data).forEach(key => {
            const item = data[key];
            calendar.addEvent({
              id: key,
              title: item.name,
              start: item.date,
              allDay: true,
              backgroundColor: item.color || "#3788d8",
              borderColor: item.color || "#3788d8"
            });
          });
        }
      }

      // ------------------------------
      // FullCalendar
      // ------------------------------

      document.addEventListener("DOMContentLoaded", function () {
        let calendarEl = document.getElementById("calendar");
        let calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          locale: "ko",
          height: "auto",
          dayHeaderFormat: { weekday: "short" },
          dayCellContent(info) {
            return { html: `<span>${info.date.getDate()}</span>` };
          },
          headerToolbar: { left: "prev,next", center: "title", right: "" },

          // ë‚ ì§œ í´ë¦­ â†’ ë“±ë¡
          dateClick: async function(info) {
            const date = info.dateStr;
            const name = prompt(date + " ì¶œì„ ì´ë¦„ ì…ë ¥");
            if (!name) return;

            // ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
            const modal = document.querySelector("#colorModal");
            modal.style.display = "flex";

            // í™•ì¸ í´ë¦­
            document.querySelector("#colorOk").onclick = async () => {
              const color = document.querySelector("#colorHex").value || "#000000";
              modal.style.display = "none";

              const result = await saveAttendance(date, name, color);

              calendar.addEvent({
                id: result.id,
                title: name,
                start: date,
                allDay: true,
                backgroundColor: color,
                borderColor: color
              });

              alert("ì¶œì„ ë“±ë¡ ì™„ë£Œ!");
            };

            // ì·¨ì†Œ í´ë¦­
            document.querySelector("#colorCancel").onclick = () => {
              modal.style.display = "none";
            };
          },

          // ì´ë²¤íŠ¸ í´ë¦­ â†’ ìˆ˜ì •/ì‚­ì œ
          eventClick: async function(info) {
            const oldName = info.event.title;
            const id = info.event.id;

            const newName = prompt(
              "ì´ë¦„ ìˆ˜ì • ë˜ëŠ” ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”\n(ë¹ˆì¹¸ ë˜ëŠ” ì·¨ì†Œí•˜ë©´ ì‚­ì œ)", 
              oldName
            );

            // ì‚­ì œ
            if (newName === null || newName.trim() === "") {
              // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
              const adminPass = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

              if (adminPass !== "1111") {   // â† ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ë°”ê¿”
                alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
                return;
              }

              const isDelete = confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
              if (!isDelete) {
                alert("ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                return;
              }

              await deleteAttendance(id);
              info.event.remove();
              alert("ì‚­ì œ ì™„ë£Œ!");
              return;
            }

            // ìˆ˜ì •
            await editAttendance(id, newName);
            info.event.setProp("title", newName);
            alert("ìˆ˜ì • ì™„ë£Œ!");
          },

          dayMaxEvents: 3,
          moreLinkText: () => "â• ë”ë³´ê¸°",
          moreLinkClick: "popover"
        });

        calendar.render();

        // ê¸°ì¡´ ì¶œì„ ë¡œë“œ
        loadAttendance(calendar);

        // ì‚¬ì´ë“œë©”ë‰´ ë²„íŠ¼ â†’ ì˜¤ëŠ˜ ì¶œì„
        $("#attendance-btn").on("click", async function () {
          let name = prompt("ì˜¤ëŠ˜ ì¶œì„í•  ì´ë¦„ ì…ë ¥");
          if (!name) return;

          let today = new Date().toISOString().split("T")[0];

          const result = await saveAttendance(today, name, "#3788d8");
          calendar.addEvent({
            id: result.id,
            title: name,
            start: today,
            allDay: true,
            backgroundColor: result.color,
            borderColor: result.color
          });

          alert("ì˜¤ëŠ˜ ì¶œì„ ì™„ë£Œ!");
        });
      });

      // "ë”ë³´ê¸°" popover ì¸ì›ìˆ˜ ìë™ í‘œì‹œ
      document.addEventListener("click", function (e) {
        // popover ì—´ë¦´ ë•Œ FullCalendarëŠ” fc-popover í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œë¥¼ ìƒì„±í•¨
        setTimeout(() => {
          const popover = document.querySelector(".fc-popover"); 
          if (!popover) return;

          // ì´ë¯¸ ì¹´ìš´íŠ¸ê°€ ì¶”ê°€ëœ ê²½ìš° ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
          if (popover.querySelector(".att-count")) return;

          // popover ë‚´ë¶€ì—ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
          const events = popover.querySelectorAll(".fc-daygrid-event");

          const count = events.length;

          // ì¹´ìš´íŠ¸ í‘œì‹œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
          const label = document.createElement("div");
          label.className = "att-count";
          label.style.fontSize = "14px";
          label.style.color = "darkslateblue";
          label.style.fontWeight = "600";
          label.style.margin = "5px 0 10px 0";
          label.style.padding = "10px 8px";
          label.style.borderBottom = "1px solid #ddd";
          label.textContent = `ì¶œì„ ì¸ì› : ${count}ëª…`;

          // popover ë§¨ ìœ„ì— ë„£ê¸°
          popover.prepend(label);
        }, 10);
      });

      // ------------------------------
      // ì»¬ëŸ¬í”¼ì»¤ â†” HEX ë™ê¸°í™”
      // ------------------------------
      const colorPicker = document.querySelector("#colorPicker");
      const colorHex = document.querySelector("#colorHex");

      colorPicker.addEventListener("input", function () {
        colorHex.value = this.value.toUpperCase();
      });

      colorHex.addEventListener("input", function () {
        const v = this.value.trim();
        const valid = /^#([0-9A-Fa-f]{6})$/.test(v);
        if (valid) colorPicker.value = v;
      });

    </script>
</body>
</html>